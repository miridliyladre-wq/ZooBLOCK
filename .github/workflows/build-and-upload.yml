name: ZooBLOCK iOS Build
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: macos-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Certificate and Profile
        env:
          CERT_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          PROV_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          CERT_PASS: ${{ secrets.P12_PASSWORD }}
        run: |
          # 1. Dosyaları oluştur
          echo $CERT_BASE64 | base64 --decode > cert.cer
          echo $PROV_BASE64 | base64 --decode > profile.mobileprovision
          
          # 2. Geçici Keychain oluştur ve sertifikayı içine aktar
          security create-keychain -p "$CERT_PASS" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$CERT_PASS" build.keychain
          security import cert.cer -k build.keychain -A -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$CERT_PASS" build.keychain
          
          # 3. Profili Apple klasörüne yerleştir
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Build and Archive
        run: |
          xcodebuild -project ZooBLOCK.xcodeproj \
            -scheme ZooBLOCK \
            -sdk iphoneos \
            -configuration Release \
            archive -archivePath $PWD/build/ZooBLOCK.xcarchive

      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath $PWD/build/ZooBLOCK.xcarchive \
            -exportPath $PWD/build/out \
            -exportOptionsPlist ExportOptions.plist
